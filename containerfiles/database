FROM postgres:17.6-bookworm

# extensions
RUN apt-get update

## timescaledb
WORKDIR /timescaledb-src

# building from source
RUN apt-get install git cmake -y # build deps

# process as of docs
RUN git clone https://github.com/timescale/timescaledb
WORKDIR /timescaledb-src/timescaledb
RUN git checkout 2.23.1
RUN apt-get install postgresql-server-dev-17 -y
RUN ./bootstrap
WORKDIR /timescaledb-src/timescaledb/build
RUN make
RUN make install

# timescaledb-tune is a separate program, build it
# RUN apt-get install go
# RUN go install github.com/timescale/timescaledb-tune/cmd/timescaledb-tune@main

## pgcrytpo is already available

## pgjwt
WORKDIR /pgjwt-src
RUN git clone https://github.com/michelp/pgjwt.git
WORKDIR /pgjwt-src/pgjwt
RUN make install

# clean up unneeded stuff that weigh the image down
RUN apt-get remove postgresql-server-dev-17 git cmake -y
RUN rm -r /var/lib/apt/lists/*
RUN rm -r /timescaledb-src
RUN rm -r /pgjwt-src

WORKDIR /src

# before running the normal entrypoint, tune timescaledb for the host
# CMD timescaledb-tune --yes && docker-entrypoint.sh
